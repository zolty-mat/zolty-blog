name: Generate Blog Content

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Article topic (e.g., "Setting up cert-manager with DNS-01 on k3s")'
        required: true
        type: string
      notes:
        description: 'Additional context or key points to cover'
        required: false
        type: string
      include_photos:
        description: 'Include placeholder for photos'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 9 * * 1'

jobs:
  generate:
    name: Generate Article Draft
    runs-on: [self-hosted, k3s, linux, amd64]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.BLOG_AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.BLOG_AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: content-gen/requirements.txt

      - name: Install dependencies
        run: pip install -r content-gen/requirements.txt

      - name: Generate article via Bedrock
        env:
          TOPIC: ${{ github.event.inputs.topic || '' }}
          NOTES: ${{ github.event.inputs.notes || '' }}
        run: python content-gen/scripts/generate_article.py

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "content: draft article on ${{ github.event.inputs.topic || 'scheduled topic' }}"
          branch: "content/draft-${{ github.run_id }}"
          title: "[Draft] ${{ github.event.inputs.topic || 'Scheduled article' }}"
          body: |
            ## Auto-generated article draft

            **Topic:** ${{ github.event.inputs.topic || 'From topics backlog' }}
            **Generated by:** AWS Bedrock (Claude 3.5 Sonnet)

            Please review, edit, and merge when ready.
            Merging to `main` will trigger the deploy workflow.
          labels: draft,auto-generated
