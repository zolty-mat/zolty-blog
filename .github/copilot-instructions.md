# zolty-blog — AI Assistant Instructions

## Memory Protocol

Before infrastructure changes: read `docs/ai-lessons.md` for failure patterns and `docs/platform-reference.md` for current state. After significant work: update the relevant `docs/` file if new knowledge was discovered. Never store secrets or credentials.

## Project Overview

This is the source repository for [blog.zolty.systems](https://blog.zolty.systems/), a public-facing homelab and infrastructure blog. The site is built with Hugo (static site generator) using the PaperMod theme, served via AWS CloudFront + S3, with content generated by AWS Bedrock and deployed via GitHub Actions.

## Critical Rules

- **Pseudonym only:** The author is always "zolty". Never use real names, email addresses, or any personally identifiable information anywhere in the codebase or content.
- **No secrets in code:** AWS keys, API tokens, and credentials live in GitHub Actions secrets only. Never hardcode them.
- **No profanity or illegal content:** This is a public-facing blog.
- **Git identity:** Commits should use `zolty <zolty@zolty.systems>` as the author.

## Architecture

- **Static site:** Hugo generates static HTML, deployed to S3, served via CloudFront CDN
- **No dynamic backend:** Comments use Giscus (GitHub Discussions). No server-side processing.
- **CI/CD:** GitHub Actions with self-hosted runners on k3s (ARC)
- **Infrastructure:** Terraform manages AWS resources (S3, CloudFront, Route53, ACM, IAM)
- **Content generation:** AWS Bedrock (Claude 3.5 Sonnet) generates article drafts via `content-gen/scripts/generate_article.py`

## Directory Structure

| Path | Purpose |
|------|---------|
| `hugo/` | Hugo site root (config, content, layouts, static assets) |
| `hugo/config/_default/` | Hugo configuration (hugo.toml, params.toml, menus.toml, markup.toml) |
| `hugo/content/posts/` | Blog articles as page bundles (each post is a directory with index.md) |
| `hugo/layouts/partials/` | Custom partials (ads, comments, SEO) |
| `hugo/layouts/shortcodes/` | Custom shortcodes (ad placement) |
| `terraform/` | AWS infrastructure (S3, CloudFront, Route53, ACM, IAM) |
| `content-gen/` | Bedrock content generation scripts and prompts |
| `.github/workflows/` | CI/CD workflows (deploy, review, terraform, generate-content) |

## Hugo Content Conventions

- Articles use **page bundles**: each post is a directory containing `index.md` and co-located images
- Front matter must include: `title`, `date`, `author` ("zolty"), `description` (150-160 chars), `tags`, `categories`
- Google Ads and Analytics are only rendered in production builds (`hugo.Environment == "production"`)
- The `{{</* ad */>}}` shortcode inserts an in-article ad placement
- **Images go directly in the page bundle directory** (same level as `index.md`, not in a subdirectory). Reference with `![alt text](filename.jpg)`
- **HEIC images must be converted to JPEG** — Hugo and browsers don't render HEIC. Convert with macOS `sips`: `sips -s format jpeg -s formatOptions 85 input.heic --out output.jpg`
- **Shortcodes do NOT render inside code blocks** — `{{</* amzn */>}}`, `{{</* youtube */>}}`, etc. inside triple-backtick fences are treated as literal text

## Monetization & Affiliate Integration

### Amazon Associates

- **Tag**: `zoltyblog07-20` (configured in `hugo.toml` params as `amazonTag`)
- **Inline shortcode**: `{{</* amzn search="Product Name" */>}}link text{{</* /amzn */>}}` — generates Amazon search URL with affiliate tag
- **Product card shortcode**: `{{</* gear-card */>}}` — styled product recommendation card
- **Disclosure**: Affiliate disclosure footer partial is included site-wide via `hugo/layouts/partials/extend_footer.html`
- **Placement guidelines**: Add affiliate links where products are naturally mentioned in the text (hardware, equipment, tools). Never force links or add them to unrelated content. Place outside code blocks.
- **Posts with affiliate links**: Cluster Genesis (M920q), GPU Passthrough (M920q), Media Stack (Synology NAS), Digital Signage (Raspberry Pi)

### DigitalOcean Referral

- **Referral code**: `b9012919f7ff`
- **Referral URL format**: `https://www.digitalocean.com/?refcode=b9012919f7ff&utm_campaign=Referral_Invite&utm_medium=Referral_Program&utm_source=badge`
- **Placement**: Blockquote callouts suggesting DigitalOcean as an alternative for readers without a homelab
- **Badge**: Displayed on the About page (`hugo/content/about.md`)
- **Posts with DO referral**: Private AI Chat, Self-Hosted CI/CD

## Media Library Integration

- **Media Library**: Self-hosted at `https://media-library.k3s.internal.strommen.systems`
- **CDN**: `https://blog.zolty.systems` (CloudFront) — media library serves optimized images
- **Workflow**: Upload photos to media library → AI generates metadata → download HEIC → convert to JPEG → place in page bundle
- **Hugo shortcode generation**: Media library provides Hugo-ready shortcodes via `/api/media/{id}/hugo`
- **YouTube embedding**: For videos uploaded to YouTube via media library, use `{{</* youtube VIDEO_ID */>}}` shortcode
- **Current media**: ~79 items (40 photos, 39 videos) — homelab hardware, rack equipment, 3D printed cases, network gear, cats

## Deployment

- Push to `main` with changes in `hugo/**` triggers automatic build and deploy
- Hugo builds with `--minify --environment production`
- Two-pass S3 sync: HTML/XML/JSON with 1hr cache, static assets with 1yr immutable cache
- CloudFront invalidation runs after every deploy

## Terraform

- State stored in S3: `k3s-homelab-tfstate-855878721457` with key `zolty-blog/terraform.tfstate`
- ACM certificate must be in `us-east-1` (CloudFront requirement)
- Changes to `terraform/` on `main` trigger auto-apply

## Content Generation

- Run `generate-content.yml` workflow with a topic to generate an article draft
- Bedrock creates a Hugo page bundle and opens a PR for review
- Weekly scheduled runs pull from `content-gen/prompts/topics.json` backlog
- System prompt enforces pseudonym usage and blog style guidelines

## Common Tasks

### Local development
```bash
cd hugo && hugo server --buildDrafts
```

### Add a new article manually
```bash
mkdir -p hugo/content/posts/my-new-article
# Create hugo/content/posts/my-new-article/index.md with front matter
```

### Generate an article via Bedrock
Trigger the `generate-content.yml` workflow via GitHub Actions UI with a topic.

### Run Terraform
```bash
cd terraform && terraform init && terraform plan
```
